<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Stall View - Precision Darts</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        * { user-select: none; -webkit-user-drag: none; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; background: #0f172a; display: flex; justify-content: center; align-items: center; height: 100vh; width: 100vw; overflow: hidden; }
        #container { position: relative; width: 100vw; height: 100vh; background: #1e293b; }
        
        #custom-cursor {
            position: fixed; width: 24px; height: 24px; pointer-events: none; z-index: 9999; display: none; transform: translate(-50%, -50%);
        }
        #custom-cursor::before, #custom-cursor::after {
            content: ''; position: absolute; background: #ff69b4; border-radius: 2px; box-shadow: 0 0 8px #ff1493;
        }
        #custom-cursor::before { top: 50%; left: 0; width: 100%; height: 4px; transform: translateY(-50%); }
        #custom-cursor::after { left: 50%; top: 0; width: 4px; height: 100%; transform: translateX(-50%); }

        #dart-inventory { position: absolute; top: 20px; right: 30px; z-index: 100; pointer-events: none; }
        .inventory-box {
            background: rgba(15, 23, 42, 0.9); border: 2px solid #ef4444; padding: 10px 20px; border-radius: 12px;
            display: flex; align-items: center; gap: 16px; color: white; font-family: 'Arial Black', sans-serif; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        #prize-tier-wrapper {
            position: absolute; top: 175px; right: 1.2in; z-index: 50; pointer-events: none;
            display: flex; flex-direction: column; align-items: center;
        }
        
        .prize-ladder {
            width: 80px; height: 300px; background: rgba(0,0,0,0.8); border: 3px solid #5d4037; border-radius: 10px;
            position: relative; display: flex; flex-direction: column-reverse; overflow: hidden;
        }
        .prize-fill-bar {
            position: absolute; bottom: 0; width: 100%; 
            background: linear-gradient(to top, #ef4444 0%, #ef4444 25%, #facc15 25%, #facc15 50%, #22c55e 50%, #22c55e 75%, #3b82f6 75%, #3b82f6 100%);
            transition: height 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 1;
        }
        .prize-step {
            flex: 1; border-top: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center;
            font-size: 9px; color: white; font-weight: bold; text-transform: uppercase; z-index: 2; text-shadow: 1px 1px 2px black;
            text-align: center;
        }
        .active-step { color: #ffffff; font-size: 11px; filter: drop-shadow(0 0 8px white); background: rgba(255,255,255,0.15); }

        .flying-dart { position: fixed; width: 60px; height: 20px; pointer-events: none; z-index: 500; transition: all 0.3s ease-out; }
        .dart-falling { transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important; transform: translate(-50%, 0) rotate(120deg) scale(0.6) !important; top: 120% !important; opacity: 0; }
        .sticky-dart { position: absolute; width: 40px; height: 12px; pointer-events: none; z-index: 1; transform-origin: 100% 50%; }

        .night-sky { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; background: radial-gradient(circle at 50% 50%, #1e293b 0%, #0f172a 100%); overflow: hidden; }
        .star { position: absolute; border-radius: 50%; pointer-events: none; opacity: 0.5; }
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        .stall-bg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none; }
        
        .balloon-board-physical { 
            position: absolute; top: 0; bottom: 20vh; 
            left: 3.2in; right: 2.8in; 
            background: #c4a484; border: 15px solid #5d4037; border-bottom: none; 
            box-shadow: inset 0 0 100px rgba(0,0,0,0.2); z-index: 1; 
            display: flex; justify-content: center; align-items: center; 
            gap: 40px; padding: 1in; cursor: none; 
            overflow: visible;
        }

        .portrait-frame { flex: 1; height: 280px; border: 6px solid #5d4037; background: rgba(255, 255, 255, 0.05); box-shadow: 0 5px 15px rgba(0,0,0,0.2); border-radius: 4px; flex-shrink: 0; z-index: 6; margin-top: 80px; position: relative; overflow: hidden; }
        
        .dart-background-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; overflow: hidden; }
        
        .internal-balloon-grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(6, 1fr); width: 100%; height: 100%; padding: 12px; box-sizing: border-box; gap: 4px; position: relative; z-index: 7; }
        .dual-circle-layout { position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: space-around; align-items: center; z-index: 7; }
        .cluster-unit { position: relative; width: 100%; height: 50%; display: flex; justify-content: center; align-items: center; }
        .rotation-engine { position: absolute; width: 100%; height: 100%; animation: clock-spin 4.5s linear infinite; transform-origin: center center; display: flex; justify-content: center; align-items: center; }
        @keyframes clock-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .clock-hand { position: absolute; width: 2px; height: 32px; background: #3e2723; transform-origin: bottom center; bottom: 50%; display: flex; flex-direction: column; align-items: center; z-index: 5; }
        
        .balloon-wrap { cursor: none; display: flex; justify-content: center; align-items: center; transition: transform 0.1s; position: relative; width: 100%; height: 100%; padding: 2px; box-sizing: border-box; }
        .balloon-wrap svg { width: 100%; height: 92%; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        
        .attached-balloon { width: 28px; height: 36px; margin-top: -32px; z-index: 10; }
        .center-balloon { position: absolute; width: 30px; height: 40px; z-index: 11; }
        
        .auntie-wrapper { position: absolute; bottom: 15vh; left: 0; width: 350px; height: 500px; transform: scale(0.95) translateX(-10%); transform-origin: bottom left; z-index: 8; pointer-events: none; }
        .speech-bubble {
            position: absolute; top: 40px; right: -120px; background: white; border-radius: 20px; padding: 12px 18px;
            width: 190px; font-family: 'Arial', sans-serif; font-weight: bold; font-size: 14px; color: #1e293b;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); opacity: 0; transform: scale(0.8); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: center; border: 3px solid #7e22ce; z-index: 100;
        }
        .speech-bubble::after {
            content: ''; position: absolute; left: -15px; top: 50%; transform: translateY(-50%);
            border-top: 10px solid transparent; border-bottom: 10px solid transparent; border-right: 15px solid white;
        }
        .bubble-visible { opacity: 1; transform: scale(1); }

        #dart-table-root { position: absolute; bottom: 0; width: 100%; height: 224px; z-index: 40; }

        .side-prize-rail {
            position: absolute;
            top: 130px;
            bottom: 85px;
            width: 80px;
            display: flex; flex-direction: column; align-items: center;
            z-index: 1000; pointer-events: none;
        }
        #left-rail { left: -48px; }
        #right-rail { right: -48px; }

        .prize-stack-container {
            display: flex; flex-direction: column; 
            justify-content: space-between;
            align-items: center; height: 100%; width: 100%;
        }
        .prize-stack-container > svg { transform: scale(1.15); flex-shrink: 0; }

        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.85); z-index: 20000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
        }

        .wood-sign {
            position: relative;
            background: #5d4037;
            background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png');
            border: 8px solid #3e2723;
            border-radius: 12px;
            padding: 40px;
            width: 500px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8), inset 0 0 40px rgba(0,0,0,0.5);
            color: #fef3c7;
            font-family: 'Arial Rounded MT Bold', 'Helvetica', sans-serif;
            text-align: center;
            transform: rotate(-1deg);
        }

        .wood-sign h1 { font-size: 32px; color: #fbbf24; margin-bottom: 20px; text-shadow: 2px 2px 0px #000; }
        .wood-sign p { margin: 12px 0; font-size: 18px; line-height: 1.4; text-shadow: 1px 1px 2px black; }
        .wood-sign b { color: #facc15; }

        .red-pin {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            width: 30px; height: 30px; background: #ef4444; border-radius: 50%;
            box-shadow: 0 4px 4px rgba(0,0,0,0.4), inset -4px -4px 8px rgba(0,0,0,0.3);
            z-index: 10;
        }
        .red-pin::after {
            content: ''; position: absolute; top: 25px; left: 50%; transform: translateX(-50%);
            border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 15px solid #94a3b8;
        }

        .play-btn {
            margin-top: 30px;
            background: #facc15;
            color: #1e293b;
            font-weight: 900;
            padding: 15px 50px;
            border-radius: 50px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 8px 0 #b45309, 0 12px 20px rgba(0,0,0,0.4);
            text-transform: uppercase;
            border: none;
        }
        .play-btn:hover { background: #fde047; transform: translateY(-2px); }
        .play-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #b45309; }

        .footer-tag {
            position: fixed;
            bottom: 3px;
            width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.4);
            font-family: Arial, sans-serif;
            font-size: 12px;
            z-index: 50;
            pointer-events: none;
        }

        .wavy-header {
            font-family: 'Microsoft JhengHei', 'Arial Black', sans-serif;
            font-size: 38px;
            font-weight: bold;
            margin-bottom: 25px;
            display: flex;
            justify-content: center;
        }

        .wavy-header span {
            display: inline-block;
            color: #f59e0b;
            text-shadow: 0 0 10px #78350f, 0 0 20px #facc15, 2px 2px 2px #000;
            animation: wave-animation 2s infinite;
        }

        @keyframes wave-animation {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        #game-over-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); 
            z-index: 30000; display: none; flex-direction: column; 
            align-items: center; justify-content: center; backdrop-filter: blur(8px);
        }

        .claim-card {
            background: #3e2723; border: 6px solid #facc15; padding: 40px; border-radius: 20px;
            text-align: center; color: white; box-shadow: 0 0 50px rgba(250, 204, 21, 0.3);
        }

        /* FIXED: Added missing semicolon after column and corrected layout properties */
        #prize-display-overlay {
            position: fixed; inset: 0; background: radial-gradient(circle, #451a03, #0c0a09);
            z-index: 40000; display: none; flex-direction: column; align-items: center; justify-content: center;
        }

        .prize-glow-container {
            width: 300px; height: 300px; display: flex; align-items: center; justify-content: center;
            background: radial-gradient(circle, rgba(250, 204, 21, 0.4) 0%, transparent 70%);
            border-radius: 50%; border: 4px dashed #facc15; margin-bottom: 30px;
            filter: drop-shadow(0 0 30px #facc15); overflow: visible;
        }

        #music-toggle {
            position: fixed; top: 20px; left: 20px; z-index: 25000;
            background: rgba(15, 23, 42, 0.8); border: 2px solid #facc15;
            color: #facc15; width: 45px; height: 45px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

    </style>
</head>
<body onclick="handleGlobalMiss(event)">

<div id="start-screen">
    <div class="wavy-header" id="wavy-title"></div>
    <div class="wood-sign">
        <div class="red-pin"></div>
        <h1>How to Play üéØ</h1>
        <p><b>Cost:</b> 100 NTD for 30 Darts.</p>
        <p><b>Aim:</b> Click to shoot. Pop as many balloons as possible.</p>
        <p><b>Prizes:</b> Hit 5, 15, or 25 balloons to climb the Prize Ladder.</p>
        <p><b>Special Prize:</b> Pop all 30 balloons without missing and hit the moving targets!</p>
        
        <button class="play-btn" onclick="startGame(event)">Play the game</button>
    </div>
</div>

<div id="music-toggle" onclick="toggleMusic(event)">üîä</div>
<div class="footer-tag">Balloon Dart Blast ¬© 2025 Developed by È¶¨ÂÖãËêä. All Rights Reserved.</div>

<div id="game-over-overlay">
    <div class="claim-card">
        <h2 style="font-size: 32px; font-family: 'Arial Black'; margin-bottom: 20px; color: #facc15;">GAME OVER!</h2>
        <p style="font-size: 20px; margin-bottom: 30px;">Darts are all used.</p>
        <button class="play-btn" onclick="claimPrize()" style="margin-top: 0;">CLAIM PRIZE!</button>
    </div>
</div>

<div id="prize-display-overlay">
    <h1 id="prize-rank-text" style="color: #facc15; font-size: 40px; font-family: 'Arial Black'; margin-bottom: 10px;"></h1>
    <div class="prize-glow-container" id="prize-icon-mount"></div>
    <button class="play-btn" onclick="location.reload()">PLAY AGAIN</button>
</div>

<div id="custom-cursor"></div>

<div id="dart-inventory">
    <div class="inventory-box">
        <div class="flex items-center gap-3 pr-4 border-r border-slate-700">
            <svg width="40" height="20" viewBox="0 0 100 30" style="transform: rotate(-30deg)">
                <path d="M5 15 L35 15 L5 2 L12 15 Z" fill="#ef4444" />
                <path d="M5 15 L35 15 L5 28 L12 15 Z" fill="#ef4444" />
                <line x1="5" y1="15" x2="85" y2="15" stroke="#78350f" stroke-width="4" />
                <path d="M85 15 L100 15 L85 10 L85 20 Z" fill="#cbd5e1" />
            </svg>
            <span id="dart-count-text" style="font-size: 28px;">30</span>
        </div>
        <div class="flex items-center gap-3">
            <svg width="24" height="30" viewBox="0 0 100 135">
                <ellipse cx="50" cy="62" rx="36" ry="54" fill="#3b82f6" />
                <path d="M50 115 L44 125 L56 125 Z" fill="#3b82f6" />
                <circle cx="40" cy="40" r="8" fill="white" opacity="0.3" />
            </svg>
            <span id="score-count-text" style="font-size: 28px; color: #60a5fa;">0</span>
        </div>
    </div>
</div>

<div id="prize-tier-wrapper">
    <div class="prize-ladder">
        <div id="prize-fill" class="prize-fill-bar" style="height: 0%"></div>
        <div class="prize-step" id="tier-small">Small</div>
        <div class="prize-step" id="tier-medium">Medium</div>
        <div class="prize-step" id="tier-large">Large</div>
        <div class="prize-step" id="tier-special">Special</div>
    </div>
    <div style="background:#5d4037; color:white; padding: 2px 8px; border-radius: 4px; font-weight:bold; font-size:10px; margin-top:8px;">PRIZE TIER</div>
</div>

<div id="container">
    <div class="night-sky" id="nightSky"></div>
    
    <div class="stall-bg-layer">
        <svg width="100%" height="100%" viewBox="0 0 1000 600" preserveAspectRatio="none">
            <defs>
                <pattern id="stripes" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">
                    <rect width="50" height="100" fill="#dc2626" /><rect x="50" width="50" height="100" fill="#ffffff" />
                </pattern>
            </defs>
            <path d="M0 0 H1000 V100 Q975 140 950 100 Q925 140 900 100 Q875 140 850 100 Q825 140 800 100 Q775 140 750 100 Q725 140 700 100 Q675 140 650 100 Q625 140 600 100 Q575 140 550 100 Q525 140 500 100 Q475 140 450 100 Q425 140 400 100 Q375 140 350 100 Q325 140 300 100 Q275 140 250 100 Q225 140 200 100 Q175 140 150 100 Q125 140 100 100 Q75 140 50 100 Q25 140 0 100 Z" fill="url(#stripes)" />
        </svg>
    </div>

    <div class="balloon-board-physical" id="gameBoard">
        <div id="left-rail" class="side-prize-rail"></div>
        <div id="right-rail" class="side-prize-rail"></div>

        <div class="portrait-frame">
            <div class="dart-background-layer" id="bg-layer-1"></div>
            <div class="internal-balloon-grid" id="grid-1"></div>
        </div>
        <div class="portrait-frame">
            <div class="dart-background-layer" id="bg-layer-2"></div>
            <div class="dual-circle-layout" id="frame-2"></div>
        </div>
        <div class="portrait-frame">
            <div class="dart-background-layer" id="bg-layer-3"></div>
            <div class="internal-balloon-grid" id="grid-3"></div>
        </div>
        <div class="portrait-frame">
            <div class="dart-background-layer" id="bg-layer-4"></div>
            <div class="dual-circle-layout" id="frame-4"></div>
        </div>
    </div>

    <div class="auntie-wrapper">
        <div class="speech-bubble" id="auntie-bubble"></div>
        <svg viewBox="0 0 300 450" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <radialGradient id="ariSkin" cx="50%" cy="40%" r="65%"><stop offset="0%" stop-color="#ffeedd" /><stop offset="70%" stop-color="#f7d3ba" /><stop offset="100%" stop-color="#d99b7e" /></radialGradient>
              <linearGradient id="ariHair" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#4a3121" /><stop offset="50%" stop-color="#2a1a10" /><stop offset="100%" stop-color="#120a06" /></linearGradient>
              <pattern id="dusterPattern" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse"><circle cx="20" cy="20" r="10" fill="#fef08a" opacity="0.1" /><path d="M5 5 L15 15 M5 15 L15 5" stroke="#9333ea" stroke-width="1" opacity="0.1" /></pattern>
              <linearGradient id="dusterGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#7e22ce" /><stop offset="100%" stop-color="#581c87" /></linearGradient>
            </defs>
            <path d="M150 70 C190 60 230 100 230 200 C230 300 200 400 170 430" fill="url(#ariHair)" opacity="0.9" />
            <path d="M90 100 C90 50 210 50 210 100 C210 130 180 145 150 145 C120 145 90 130 90 100" fill="url(#ariHair)" />
            <g opacity="0.9"><path d="M100 230 Q85 260 90 300" stroke="#f7d3ba" stroke-width="14" fill="none" stroke-linecap="round" /><path d="M200 230 Q215 260 210 300" stroke="#f7d3ba" stroke-width="14" fill="none" stroke-linecap="round" /></g>
            <path d="M130 190 Q150 210 170 190 L165 220 L135 220 Z" fill="#f7d3ba" />
            <path d="M105 110 C105 85 195 85 195 110 C195 170 180 205 150 205 C120 205 105 170 105 110 Z" fill="url(#ariSkin)" />
            <g>
              <path d="M115 138 Q125 132 138 138 Q125 142 115 138 Z" fill="#fff" /><circle cx="128" cy="138" r="4" fill="#3e2723" /><circle cx="129" cy="137" r="1" fill="white" opacity="0.8" /><path d="M112 136 L142 134" stroke="black" stroke-width="2" fill="none" stroke-linecap="round" />
              <path d="M162 138 Q175 132 185 138 Q175 142 162 138 Z" fill="#fff" /><circle cx="172" cy="138" r="4" fill="#3e2723" /><circle cx="173" cy="137" r="1" fill="white" opacity="0.8" /><path d="M158 134 L188 136" stroke="black" stroke-width="2" fill="none" stroke-linecap="round" />
            </g>
            <path d="M147 166 Q150 171 153 166" stroke="#d99b7e" stroke-width="1.5" fill="none" stroke-linecap="round" opacity="0.7" />
            <path d="M115 120 Q130 112 145 122" stroke="#2a1a10" stroke-width="1.5" fill="none" opacity="0.5" />
            <path d="M155 122 Q170 112 185 120" stroke="#2a1a10" stroke-width="1.5" fill="none" opacity="0.5" />
            <path d="M138 185 Q150 192 162 185 Q150 187 138 185" fill="#f4a7a7" stroke="#9d174d" stroke-width="0.5" />
            <g><path d="M100 220 L200 220 L240 450 L60 450 Z" fill="url(#dusterGrad)" /><path d="M100 220 L200 220 L240 450 L60 450 Z" fill="url(#dusterPattern)" /><path d="M150 220 L150 450" stroke="rgba(0,0,0,0.15)" stroke-width="2" fill="none" /><circle cx="150" cy="280" r="2.5" fill="rgba(255,255,255,0.2)" /><circle cx="150" cy="330" r="2.5" fill="rgba(255,255,255,0.2)" /><circle cx="150" cy="380" r="2.5" fill="rgba(255,255,255,0.2)" /></g>
        </svg>
    </div>
    <div id="dart-table-root"></div>
</div>

<script type="text/babel">
    const { useMemo } = React;
    const mulberry32 = (a) => () => { let t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; };
    
    const StuffedElephant = ({scale=1}) => (<svg viewBox="0 0 120 160" className={`w-16 h-24 drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)]`} style={{transform: `scale(${scale})` }}><ellipse cx="20" cy="80" rx="25" ry="35" fill="#94a3b8" /><ellipse cx="100" cy="80" rx="25" ry="35" fill="#94a3b8" /><ellipse cx="22" cy="80" rx="15" ry="25" fill="#fbcfe8" opacity="0.4" /><ellipse cx="98" cy="80" rx="15" ry="25" fill="#fbcfe8" opacity="0.4" /><ellipse cx="25" cy="115" rx="12" ry="20" fill="#64748b" transform="rotate(20, 25, 115)" /><ellipse cx="95" cy="115" rx="12" ry="20" fill="#64748b" transform="rotate(-20, 95, 115)" /><ellipse cx="60" cy="120" rx="45" ry="40" fill="#94a3b8" /><ellipse cx="60" cy="120" rx="25" ry="20" fill="#f8fafc" opacity="0.3" /><circle cx="60" cy="85" r="40" fill="#94a3b8" /><path d="M60 95 Q60 135 80 130" stroke="#94a3b8" strokeWidth="14" fill="none" strokeLinecap="round" /><circle cx="45" cy="80" r="4" fill="#1e1b4b" /><circle cx="75" cy="80" r="4" fill="#1e1b4b" /></svg>);
    const StuffedDog = ({scale=1}) => (<svg viewBox="0 0 120 160" className={`w-16 h-24 drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)]`} style={{transform: `scale(${scale})` }}><ellipse cx="20" cy="100" rx="18" ry="28" fill="#d97706" transform="rotate(25, 20, 100)" /><ellipse cx="100" cy="100" rx="18" ry="28" fill="#d97706" transform="rotate(-25, 100, 100)" /><path d="M15 40 Q-10 40 0 85 Q5 110 25 95 Z" fill="#78350f" transform="rotate(-5, 15, 40)" /><path d="M105 40 Q130 40 120 85 Q115 110 95 95 Z" fill="#78350f" transform="rotate(5, 105, 40)" /><ellipse cx="60" cy="115" rx="48" ry="42" fill="#d97706" /><ellipse cx="60" cy="115" rx="28" ry="24" fill="#f59e0b" opacity="0.3" /><circle cx="35" cy="148" r="10" fill="#78350f" /><circle cx="85" cy="148" r="10" fill="#78350f" /><circle cx="60" cy="55" r="42" fill="#78350f" /><ellipse cx="60" cy="72" rx="24" ry="20" fill="#fef3c7" /><circle cx="45" cy="60" r="7" fill="#1e1b4b" /><circle cx="75" cy="60" r="7" fill="#1e1b4b" /></svg>);
    const StuffedChase = ({scale=1}) => (<svg viewBox="0 0 120 160" className={`w-16 h-24 drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)]`} style={{transform: `scale(${scale})` }}><ellipse cx="20" cy="110" rx="14" ry="25" fill="#78350f" transform="rotate(25, 20, 110)" /><ellipse cx="100" cy="110" rx="14" ry="25" fill="#78350f" transform="rotate(-25, 100, 110)" /><ellipse cx="60" cy="120" rx="45" ry="40" fill="#1e40af" /><path d="M40 95 L80 95 L85 140 L35 140 Z" fill="#1e3a8a" /><rect x="55" y="105" width="10" height="10" fill="#facc15" rx="2" /><circle cx="60" cy="65" r="42" fill="#78350f" /><ellipse cx="60" cy="80" rx="22" ry="18" fill="#d97706" /><path d="M25 45 Q60 25 95 45 L90 55 L30 55 Z" fill="#1e3a8a" /><rect x="30" y="52" width="60" height="5" fill="#000" /><circle cx="60" cy="40" r="6" fill="#facc15" /><circle cx="48" cy="70" r="4.5" fill="#1e1b4b" /><circle cx="72" cy="70" r="4.5" fill="#1e1b4b" /><ellipse cx="60" cy="80" rx="6" ry="4" fill="#000" /></svg>);
    const StuffedWhale = ({scale=1}) => (<svg viewBox="0 0 120 160" className={`w-16 h-24 drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)]`} style={{transform: `scale(${scale})` }}><g opacity="0.8"><path d="M60 40 Q55 20 45 25" fill="none" stroke="#bae6fd" strokeWidth="3" strokeLinecap="round" /><path d="M60 40 Q65 20 75 25" fill="none" stroke="#bae6fd" strokeWidth="3" strokeLinecap="round" /></g><ellipse cx="40" cy="130" rx="20" ry="10" fill="#60a5fa" transform="rotate(-30, 40, 130)" /><ellipse cx="80" cy="130" rx="20" ry="10" fill="#60a5fa" transform="rotate(30, 80, 130)" /><ellipse cx="60" cy="85" rx="50" ry="45" fill="#60a5fa" /><ellipse cx="60" cy="105" rx="40" ry="25" fill="#fff" opacity="0.9" /><circle cx="40" cy="80" r="4" fill="#1e1b4b" /><circle cx="80" cy="80" r="4" fill="#1e1b4b" /><path d="M50 95 Q60 102 70 95" stroke="#1e1b4b" strokeWidth="2" fill="none" strokeLinecap="round" /></svg>);
    const StuffedShark = ({scale=1}) => (<svg viewBox="0 0 120 160" className={`w-16 h-24 drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)]`} style={{transform: `scale(${scale})` }}><path d="M50 40 Q75 10 90 40 Z" fill="#64748b" transform="rotate(-15, 60, 40)" /><ellipse cx="60" cy="95" rx="55" ry="45" fill="#64748b" /><ellipse cx="60" cy="115" rx="45" ry="25" fill="#f8fafc" /><path d="M15 95 Q-10 110 15 120" fill="#475569" /><path d="M105 95 Q130 110 105 120" fill="#475569" /><circle cx="40" cy="90" r="4.5" fill="#1e1b4b" /><circle cx="80" cy="90" r="4.5" fill="#1e1b4b" /><path d="M50 105 Q60 112 70 105" stroke="#1e1b4b" strokeWidth="2" fill="none" strokeLinecap="round" /></svg>);
    const StuffedPenguin = ({scale=1}) => (<svg viewBox="0 0 120 160" className={`w-16 h-24 drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)]`} style={{transform: `scale(${scale})` }}><ellipse cx="15" cy="105" rx="8" ry="22" fill="#000" transform="rotate(25, 15, 105)" /><ellipse cx="105" cy="105" rx="8" ry="22" fill="#000" transform="rotate(-25, 105, 105)" /><ellipse cx="42" cy="148" rx="14" ry="8" fill="#f97316" /><ellipse cx="78" cy="148" rx="14" ry="8" fill="#f97316" /><ellipse cx="60" cy="95" rx="48" ry="58" fill="#000" /><ellipse cx="60" cy="105" rx="35" ry="45" fill="#fff" /><circle cx="45" cy="75" r="4.5" fill="#000" /><circle cx="75" cy="75" r="4.5" fill="#000" /><path d="M52 85 L68 85 L60 98 Z" fill="#fb923c" /></svg>);

    window.StuffedWhale = StuffedWhale;
    window.StuffedShark = StuffedShark;
    window.StuffedElephant = StuffedElephant;
    window.StuffedPenguin = StuffedPenguin;

    const PrizeStack = () => (
        <div className="prize-stack-container">
            <StuffedElephant /><StuffedDog /><StuffedChase /><StuffedWhale /><StuffedShark /><StuffedPenguin />
        </div>
    );

    const InsideDart = ({ color }) => (
        <svg width="10" height="32" viewBox="0 0 100 300">
            <path d="M5 80 L50 80 L5 0 L25 80 Z" fill={color} />
            <path d="M95 80 L50 80 L95 0 L75 80 Z" fill={color} />
            <rect x="42" y="80" width="16" height="220" fill="#78350f" />
        </svg>
    );

    const MiniDuck = ({ scale = 1 }) => (<svg viewBox="0 0 40 40" style={{ width: 32 * scale, height: 32 * scale }}><path d="M10 25 Q10 35 25 35 Q35 35 35 25 Q35 15 25 15 L22 15 Q22 5 12 5 Q2 5 2 15 Q2 25 10 25" fill="#facc15" /><circle cx="15" cy="12" r="1.5" fill="#1e293b" /><path d="M2 15 Q-2 15 0 18 L4 18 Z" fill="#f97316" /></svg>);
    const MiniCar = ({ scale = 1, color = "#ef4444" }) => (<svg viewBox="0 0 40 40" style={{ width: 40 * scale, height: 32 * scale }}><rect x="5" y="20" width="30" height="10" rx="4" fill={color} /><path d="M10 20 L15 10 L25 10 L30 20 Z" fill="#93c5fd" /><circle cx="10" cy="30" r="4" fill="#1e293b" /><circle cx="30" cy="30" r="4" fill="#1e293b" /></svg>);
    const MiniBall = ({ scale = 1, color = "#3b82f6" }) => (<svg viewBox="0 0 40 40" style={{ width: 28 * scale, height: 28 * scale }}><circle cx="20" cy="20" r="15" fill={color} /><path d="M5 20 Q20 5 35 20" stroke="white" strokeWidth="2" fill="none" opacity="0.4" /></svg>);
    const MiniRobot = ({ scale = 1, color = "#94a3b8" }) => (<svg viewBox="0 0 40 50" style={{ width: 36 * scale, height: 45 * scale }}><rect x="10" y="15" width="20" height="20" rx="2" fill={color} /><rect x="12" y="5" width="16" height="10" rx="3" fill={color} /><circle cx="16" cy="10" r="1.5" fill="#ef4444" /><circle cx="24" cy="10" r="1.5" fill="#ef4444" /><rect x="8" y="18" width="4" height="12" rx="1" fill="#64748b" /><rect x="28" y="18" width="4" height="12" rx="1" fill="#64748b" /><path d="M18 2 L22 2 L20 6 Z" fill="#facc15" /></svg>);
    const MiniCat = ({ scale = 1, color = "#f8fafc" }) => (<svg viewBox="0 0 40 40" style={{ width: 32 * scale, height: 32 * scale }}><circle cx="20" cy="25" r="12" fill={color} /><circle cx="20" cy="15" r="10" fill={color} /><circle cx="17" cy="14" r="1" fill="#1e293b" /><circle cx="23" cy="14" r="1" fill="#1e293b" /></svg>);

    const DartTable = () => {
      const toyTypes = ['duck', 'car', 'ball', 'robot', 'cat'];
      const colors = ["#ef4444", "#3b82f6", "#22c55e", "#facc15", "#8b5cf6"];
      const cupColors = ["#8b5cf6", "#3b82f6", "#22c55e", "#f97316", "#ec4899", "#ef4444"];
      const toyCollection = useMemo(() => {
        const rand = mulberry32(12345);
        return [...Array(150)].map(() => ({ type: toyTypes[Math.floor(rand()*5)], scale: 1.2+rand()*0.6, rot: (rand()-0.5)*20, y: -5-(rand()*20), x: -700+(rand()*1400), color: colors[Math.floor(rand()*5)], zIndex: 50+Math.floor(rand()*10) }));
      }, []);
      return (
        <div className="absolute bottom-0 w-full h-56 flex flex-col items-center justify-end pointer-events-none">
          <div className="relative w-[120%] h-24 bg-amber-900 border-b-2 border-amber-950 shadow-[0_-20px_50px_rgba(0,0,0,0.6)]" style={{ transform: 'perspective(600px) rotateX(40deg)', marginBottom: '-30px' }}><div className="absolute inset-0 opacity-40 bg-[url('https://www.transparenttextures.com/patterns/dark-wood.png')]"></div></div>
          <div className="relative w-full h-40 bg-amber-950 border-t-8 border-pink-700 shadow-[0_-30px_60px_rgba(0,0,0,0.9)] flex flex-col items-center">
            <div className="absolute top-[-36px] left-0 right-0 h-10 overflow-visible">
                {toyCollection.map((toy, i) => {
                    const Comp = toy.type === 'duck' ? MiniDuck : toy.type === 'car' ? MiniCar : toy.type === 'ball' ? MiniBall : toy.type === 'robot' ? MiniRobot : MiniCat;
                    return <div key={i} className="absolute" style={{ left: `calc(50% + ${toy.x}px)`, top: toy.y, transform: `translateX(-50%) rotate(${toy.rot}deg)`, zIndex: toy.zIndex }}><Comp scale={toy.scale} color={toy.color} /></div>
                })}
            </div>
            <div className="absolute inset-x-0 top-3 flex justify-around px-20">
              {cupColors.map((color, i) => (
                <div key={i} className="relative w-28 h-32 flex flex-col items-center justify-start">
                    <div className="relative w-16 h-28 overflow-hidden" style={{ borderRadius: '0 0 12px 12px' }}>
                        <div className="absolute inset-0 flex items-start justify-center pt-2 z-10">
                            <div className="flex flex-wrap justify-center w-full px-1">
                                {[...Array(8)].map((_, idx) => (
                                    <div key={idx} style={{ margin: '-3px', transform: `rotate(${(idx - 3.5) * 6}deg) translateY(${Math.abs(idx-3.5) * 3}px)` }}>
                                        <InsideDart color="#ef4444" />
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="absolute inset-0 z-20" style={{ backgroundColor: color, clipPath: 'polygon(0% 25%, 100% 25%, 100% 100%, 0% 100%)', boxShadow: 'inset 0 -10px 20px rgba(0,0,0,0.3)' }}></div>
                    </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('dart-table-root')).render(<DartTable />);
    ReactDOM.createRoot(document.getElementById('left-rail')).render(<PrizeStack />);
    ReactDOM.createRoot(document.getElementById('right-rail')).render(<PrizeStack />);
</script>

<script>
    let dartsThrown = 0; let totalHits = 0; 
    let totalMisses = 0; let nearMisses = 0;
    let missedAny = false; let hitAnySteady = false;
    let gameStarted = false;
    let musicInterval = null;
    
    const DART_SVG = `<svg viewBox="0 0 100 30" style="width:100%; height:100%; overflow:visible;"><path d="M85 15 L100 15 L85 10 L85 20 Z" fill="#cbd5e1" /><rect x="75" y="14" width="10" height="2" fill="#94a3b8" /><rect x="65" y="12" width="10" height="6" rx="1" fill="#475569" /><rect x="30" y="13.5" width="35" height="3" fill="#78350f" /><path d="M5 15 L35 15 L5 2 L12 15 Z" fill="#ef4444" /><path d="M5 15 L35 15 L5 28 L12 15 Z" fill="#ef4444" /></svg>`;
    const cursor = document.getElementById('custom-cursor');
    const dartCounterText = document.getElementById('dart-count-text');
    const scoreCounterText = document.getElementById('score-count-text');
    const prizeFill = document.getElementById('prize-fill');
    const auntieBubble = document.getElementById('auntie-bubble');
    const gameBoard = document.getElementById('gameBoard');

    const titleStr = "Ê≠°ËøéÂÖâËá® È¶¨ÂÖãËêäÁöÑÊ∞£ÁêÉÂ∞ÑÈè¢Á´∂ÊäÄ";
    const titleContainer = document.getElementById('wavy-title');
    titleStr.split('').forEach((char, i) => {
        const span = document.createElement('span');
        span.innerText = char === ' ' ? '\u00A0' : char;
        span.style.animationDelay = (i * 0.1) + 's';
        titleContainer.appendChild(span);
    });

    function startGame(e) {
        e.stopPropagation();
        document.getElementById('start-screen').style.display = 'none';
        gameStarted = true;
        startBackgroundMusic();
    }

    function showAuntieComment(text) {
        auntieBubble.innerText = text;
        auntieBubble.classList.add('bubble-visible');
        setTimeout(() => auntieBubble.classList.remove('bubble-visible'), 3000);
    }

    document.addEventListener('mousemove', (e) => {
        if (!gameStarted) return;
        const isOverBoard = e.target.closest('.balloon-board-physical');
        cursor.style.display = (isOverBoard && (30 - dartsThrown) > 0) ? 'block' : 'none';
        cursor.style.left = e.clientX + 'px'; cursor.style.top = e.clientY + 'px';
    });

    function updatePrizeLadder() {
        scoreCounterText.innerText = totalHits;
        document.querySelectorAll('.prize-step').forEach(s => s.classList.remove('active-step'));
        let targetHeight = 0;
        if (totalHits === 30 && !missedAny && !hitAnySteady) { targetHeight = 100; document.getElementById('tier-special').classList.add('active-step'); }
        else if (totalHits >= 25) { targetHeight = 75; document.getElementById('tier-large').classList.add('active-step'); }
        else if (totalHits >= 15) { targetHeight = 50; document.getElementById('tier-medium').classList.add('active-step'); }
        else if (totalHits >= 5) { targetHeight = 25; document.getElementById('tier-small').classList.add('active-step'); }
        prizeFill.style.height = targetHeight + '%';
    }

    function checkGameOver() {
        if (dartsThrown === 30) {
            clearInterval(musicInterval);
            setTimeout(() => {
                playGameOverSound();
                document.getElementById('game-over-overlay').style.display = 'flex';
            }, 1000);
        }
    }

    // FIXED: Corrected mapping and icon placement root creation
    function claimPrize() {
        playVictorySound();
        document.getElementById('game-over-overlay').style.display = 'none';
        const display = document.getElementById('prize-display-overlay');
        const mount = document.getElementById('prize-icon-mount');
        const rankText = document.getElementById('prize-rank-text');
        display.style.display = 'flex';

        // Clear previous content
        mount.innerHTML = "";

        let Component = null;
        let rank = "NO PRIZE";

        // Logic check matching ladder
        if (totalHits === 30 && !missedAny && !hitAnySteady) { 
            Component = window.StuffedWhale; rank = "SPECIAL PRIZE!"; 
        } else if (totalHits >= 25) { 
            Component = window.StuffedShark; rank = "LARGE PRIZE!"; 
        } else if (totalHits >= 15) { 
            Component = window.StuffedElephant; rank = "MEDIUM PRIZE!"; 
        } else if (totalHits >= 5) { 
            Component = window.StuffedPenguin; rank = "SMALL PRIZE!"; 
        }

        rankText.innerText = rank;
        if (Component) {
            const root = ReactDOM.createRoot(mount);
            // Increased scale for impact on claim screen
            root.render(React.createElement(Component, { scale: 2.2 }));
        } else {
            mount.innerHTML = "<div style='color:white; text-align: center; font-size:24px; font-family:Arial Black;'>BETTER LUCK NEXT TIME!</div>";
        }
    }

    function handleGlobalMiss(e) { 
        if (!gameStarted || dartsThrown >= 30) return;
        if (e.target.closest('.balloon-board-physical') && !e.target.closest('.balloon-wrap')) { 
            missedAny = true; 
            handlePop(e, null, false, null); 
        } 
    }

    function handlePop(e, balloonWrap, isMoving, bgLayerId) {
        if (!gameStarted || dartsThrown >= 30) return;
        dartsThrown++; dartCounterText.innerText = 30 - dartsThrown;
        
        const flyer = document.createElement('div'); 
        flyer.className = 'flying-dart'; 
        flyer.innerHTML = DART_SVG;
        
        const startX = window.innerWidth / 2; 
        const startY = window.innerHeight;
        const clickX = e.clientX; 
        const clickY = e.clientY;
        
        flyer.style.left = startX + 'px'; 
        flyer.style.top = startY + 'px';
        flyer.style.transform = 'translate(-50%, -50%) rotate(-90deg) scale(2)';
        document.body.appendChild(flyer);

        setTimeout(() => { 
            flyer.style.left = clickX + 'px'; 
            flyer.style.top = clickY + 'px'; 
            flyer.style.transform = 'translate(-50%, -50%) rotate(-90deg) scale(0.6)'; 
        }, 10);

        setTimeout(() => {
            let isPrecisionHit = false;
            let isNearMiss = false;
            let finalBgLayerId = bgLayerId;

            if (balloonWrap) {
                const rect = balloonWrap.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2; 
                const centerY = rect.top + rect.height / 2;
                const dist = Math.sqrt(Math.pow(clickX - centerX, 2) + Math.pow(clickY - centerY, 2));
                if (dist < 32) isPrecisionHit = true;
                else if (dist < 65) isNearMiss = true;

                if (!finalBgLayerId) {
                    const frame = balloonWrap.closest('.portrait-frame');
                    if (frame) {
                        const bg = frame.querySelector('.dart-background-layer');
                        if (bg) finalBgLayerId = bg.id;
                    }
                }
            }

            if (isPrecisionHit && balloonWrap) {
                totalHits++; 
                if (!isMoving) hitAnySteady = true;
                updatePrizeLadder(); 
                balloonWrap.querySelector('svg').style.display = 'none'; 
                balloonWrap.style.pointerEvents = 'none'; 
                
                playPopSound();

                const targetContainer = document.getElementById(finalBgLayerId) || gameBoard;
                const targetRect = targetContainer.getBoundingClientRect();
                const stuckDart = document.createElement('div');
                stuckDart.className = 'sticky-dart';
                stuckDart.innerHTML = DART_SVG;
                stuckDart.style.left = (clickX - targetRect.left) + 'px';
                stuckDart.style.top = (clickY - targetRect.top) + 'px';
                const slant = (Math.random() * 20) - 10;
                stuckDart.style.transform = `translate(-100%, -50%) rotate(${-90 + slant}deg) scale(0.7)`;
                targetContainer.appendChild(stuckDart);
                flyer.remove();
            } else { 
                missedAny = true; 
                totalMisses++;
                if (isNearMiss) nearMisses++;

                if (nearMisses === 2) showAuntieComment("Oh! You almost hit it! Just almost though");
                else if (totalMisses === 5) showAuntieComment("The balloon is not flying, just chill human");
                
                playFallingSound();
                flyer.classList.add('dart-falling'); 
                setTimeout(() => flyer.remove(), 900); 
            }
            checkGameOver();
        }, 300);
    }

    function getBalloonHTML(id, color) { return `<svg viewBox="0 0 100 135"><defs><radialGradient id="g-${id}" cx="40%" cy="40%" r="50%"><stop offset="0%" stop-color="white" stop-opacity="0.3"/><stop offset="100%" stop-color="black" stop-opacity="0.1"/></radialGradient></defs><ellipse cx="50" cy="62" rx="36" ry="54" fill="${color}" /><ellipse cx="50" cy="62" rx="36" ry="54" fill="url(#g-${id})" /><path d="M50 115 L44 125 L56 125 Z" fill="${color}" /></svg>`; }
    function populateGrid(id) { const c = document.getElementById(id); for(let i=0;i<24;i++){ const w=document.createElement('div'); w.className='balloon-wrap'; w.innerHTML=getBalloonHTML(id+i,['#ef4444','#3b82f6','#22c55e','#eab308','#a855f7'][i%5]); w.onclick=(e)=>{e.stopPropagation(); handlePop(e,w,false);}; c.appendChild(w); }}
    function createMechanicalCluster(p, pr, bg) { 
        const u=document.createElement('div'); u.className='cluster-unit'; p.appendChild(u);
        const e=document.createElement('div'); e.className='rotation-engine'; u.appendChild(e);
        for(let i=0;i<10;i++){ 
            const h=document.createElement('div'); h.className='clock-hand'; h.style.transform=`rotate(${(i/10)*360}deg)`;
            const w=document.createElement('div'); w.className='balloon-wrap attached-balloon'; w.innerHTML=getBalloonHTML(pr+i,['#ef4444','#f97316','#eab308','#22c55e','#3b82f6'][i%5]); w.onclick=(e)=>{e.stopPropagation(); handlePop(e,w,true,bg);};
            h.appendChild(w); e.appendChild(h);
        }
        const m=document.createElement('div'); m.className='balloon-wrap center-balloon'; m.innerHTML=getBalloonHTML(pr+'c','#f97316'); m.onclick=(e)=>{e.stopPropagation(); handlePop(e,m,true,bg);}; u.appendChild(m);
    }

    populateGrid('grid-1'); populateGrid('grid-3');
    createMechanicalCluster(document.getElementById('frame-2'),'f2t','bg-layer-2'); createMechanicalCluster(document.getElementById('frame-2'),'f2b','bg-layer-2');
    createMechanicalCluster(document.getElementById('frame-4'),'f4t','bg-layer-4'); createMechanicalCluster(document.getElementById('frame-4'),'f4b','bg-layer-4');

    (function() {
        const sky = document.getElementById('nightSky');
        for(let i=0; i<300; i++) {
            const star = document.createElement('div'); star.className = 'star';
            const size = Math.random() * 2.5 + 0.5;
            star.style.width = size + 'px'; star.style.height = size + 'px';
            star.style.left = Math.random() * 100 + '%'; star.style.top = Math.random() * 100 + '%';
            star.style.backgroundColor = '#ffffff'; star.style.animation = `twinkle ${1.5 + Math.random() * 3.5}s infinite ease-in-out`;
            sky.appendChild(star);
        }
    })();

    let audioCtx = null;
    let masterGain = null;
    let isMuted = false;

    function initAudio() {
        if (audioCtx) return;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.4;
        masterGain.connect(audioCtx.destination);
    }

    function toggleMusic(e) {
        e.stopPropagation();
        if (!audioCtx) initAudio();
        isMuted = !isMuted;
        masterGain.gain.setTargetAtTime(isMuted ? 0 : 0.4, audioCtx.currentTime, 0.1);
        document.getElementById('music-toggle').innerText = isMuted ? 'üîá' : 'üîä';
    }

    function startBackgroundMusic() {
        initAudio();
        const tempo = 140; 
        const noteLength = 60 / tempo / 2; 
        let step = 0;

        const melody = [60, 60, 64, 67, 60, 0, 72, 72, 65, 65, 69, 72, 65, 0, 71, 71];
        const bass = [36, 0, 36, 0, 41, 0, 43, 0];

        musicInterval = setInterval(() => {
            if (gameStarted && !isMuted) {
                const now = audioCtx.currentTime;
                if (step % 2 === 0) {
                    const mNote = melody[(step/2) % melody.length];
                    if (mNote > 0) {
                        const osc = audioCtx.createOscillator();
                        const g = audioCtx.createGain();
                        osc.type = 'square';
                        osc.frequency.setValueAtTime(440 * Math.pow(2, (mNote - 69) / 12), now);
                        g.gain.setValueAtTime(0.06, now);
                        g.gain.exponentialRampToValueAtTime(0.0001, now + 0.15);
                        osc.connect(g).connect(masterGain);
                        osc.start(); osc.stop(now + 0.15);
                    }
                }
                if (step % 4 === 0) {
                    const bNote = bass[(step/4) % bass.length];
                    const osc = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(440 * Math.pow(2, (bNote - 69) / 12), now);
                    g.gain.setValueAtTime(0.15, now);
                    g.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.connect(g).connect(masterGain);
                    osc.start(); osc.stop(now + 0.3);
                }
                step++;
            }
        }, noteLength * 1000);
    }

    function playPopSound() {
        if (!audioCtx || isMuted) return;
        const now = audioCtx.currentTime;
        const noiseBuffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.05, audioCtx.sampleRate);
        const output = noiseBuffer.getChannelData(0);
        for (let i = 0; i < noiseBuffer.length; i++) output[i] = Math.random() * 2 - 1;
        const noise = audioCtx.createBufferSource();
        noise.buffer = noiseBuffer;
        const filter = audioCtx.createBiquadFilter();
        filter.type = 'highpass';
        filter.frequency.setValueAtTime(2500, now);
        const gain = audioCtx.createGain();
        gain.gain.setValueAtTime(0.6, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.04);
        noise.connect(filter).connect(gain).connect(masterGain);
        noise.start();
        const thump = audioCtx.createOscillator();
        const thumpGain = audioCtx.createGain();
        thump.type = 'sine';
        thump.frequency.setValueAtTime(150, now);
        thump.frequency.exponentialRampToValueAtTime(40, now + 0.1);
        thumpGain.gain.setValueAtTime(0.3, now);
        thumpGain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
        thump.connect(thumpGain).connect(masterGain);
        thump.start(); thump.stop(now + 0.15);
    }

    function playFallingSound() {
        if (!audioCtx || isMuted) return;
        const now = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(1200, now);
        osc.frequency.linearRampToValueAtTime(100, now + 0.7);
        g.gain.setValueAtTime(0.12, now);
        g.gain.linearRampToValueAtTime(0, now + 0.7);
        osc.connect(g).connect(masterGain);
        osc.start(); osc.stop(now + 0.7);
    }

    function playGameOverSound() {
        if (!audioCtx || isMuted) return;
        const now = audioCtx.currentTime;
        [220, 196, 174, 146].forEach((f, i) => {
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(f, now + i*0.25);
            g.gain.setValueAtTime(0.2, now + i*0.25);
            g.gain.exponentialRampToValueAtTime(0.0001, now + i*0.25 + 0.6);
            osc.connect(g).connect(masterGain);
            osc.start(now + i*0.25); osc.stop(now + i*0.25 + 0.6);
        });
    }

    function playVictorySound() {
        if (!audioCtx || isMuted) return;
        const now = audioCtx.currentTime;
        const notes = [523, 659, 783, 1046, 783, 1046, 1318];
        notes.forEach((f, i) => {
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(f, now + i*0.08);
            g.gain.setValueAtTime(0.15, now + i*0.08);
            g.gain.exponentialRampToValueAtTime(0.01, now + i*0.08 + 0.3);
            osc.connect(g).connect(masterGain);
            osc.start(now + i*0.08); osc.stop(now + i*0.08 + 0.3);
        });
    }
</script>
</body>
</html>
